<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon.png" />
  <title>一个趣味会议软件</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ccc; border-radius: 8px; }
    input, button { padding: 8px; margin: 5px; }
    .message { margin: 5px 0; padding: 5px; background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>趣味会议软件</h1>
  <a href="./index.html">返回首页</a>

  <!-- 用户注册/登录 -->
  <div class="section">
    <h2>用户注册/登录</h2>
    <input type="text" id="username" placeholder="用户名" />
    <input type="password" id="password" placeholder="密码" />
    <button onclick="register()">注册</button>
    <button onclick="login()">登录</button>
    <div id="user-status"></div>
  </div>

  <!-- 房间管理 -->
  <div class="section">
    <h2>房间管理</h2>
    <input type="text" id="room-name" placeholder="房间名" />
    <input type="text" id="room-intro" placeholder="简介" />
    <input type="text" id="invite-code" placeholder="邀请码" />
    <button onclick="createRoom()">创建房间</button>
    <input type="text" id="join-code" placeholder="输入邀请码加入房间" />
    <button onclick="joinRoom()">加入房间</button>
    <div id="room-list"></div>
  </div>

  <!-- 消息管理 -->
  <div class="section">
    <h2>消息管理</h2>
    <input type="text" id="message-content" placeholder="输入消息" />
    <button onclick="sendMessage()">发送消息</button>
    <div id="message-list"></div>
  </div>

  <!-- 会议管理 -->
  <div class="section">
    <h2>会议管理</h2>
    <input type="text" id="meeting-name" placeholder="会议名称" />
    <input type="datetime-local" id="start-time" />
    <input type="datetime-local" id="end-time" />
    <button onclick="createMeeting()">创建会议</button>
    <div id="meeting-list"></div>
  </div>

  <!-- 会议笔记 -->
  <div class="section">
    <h2>会议笔记</h2>
    <input type="text" id="note-content" placeholder="笔记内容" />
    <button onclick="addNote()">添加笔记</button>
    <div id="note-list"></div>
  </div>

  <br /><br />
  <div>&copy;&nbsp;李健《风吹麦浪》</div>
  <audio id="main-background-music" src="./assets/李健-风吹麦浪.mp3" controls autoplay loop></audio>

  <!-- Apollo Client CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@apollo/client@3.7.10/dist/bundle.umd.js"></script>
  <script>
    const client = new Apollo.ApolloClient({
      uri: 'https://rational-stallion-89.hasura.app/v1/graphql',
      cache: new Apollo.InMemoryCache(),
      headers: {
        'x-hasura-admin-secret': 'ea3f7d6b-5a0b-4e0b-9e6a-1c2d3e4f5a6b'
      }
    });

    let currentUser = null;
    let currentRoom = null;

    // 注册
    async function register() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const mutation = `
        mutation {
          insert_user_one(object: {username: "${username}", password: "${password}"}) {
            uuid
          }
        }
      `;
      const result = await client.mutate({ mutation });
      alert('注册成功！');
    }

    // 登录
    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const query = `
        query {
          user(where: {username: {_eq: "${username}"}}) {
            uuid
            password
          }
        }
      `;
      const result = await client.query({ query });
      if (result.data.user.length > 0 && result.data.user[0].password === password) {
        currentUser = result.data.user[0];
        document.getElementById('user-status').innerText = `已登录：${username}`;
      } else {
        alert('用户名或密码错误');
      }
    }

    // 创建房间
    async function createRoom() {
      const name = document.getElementById('room-name').value;
      const intro = document.getElementById('room-intro').value;
      const inviteCode = document.getElementById('invite-code').value;
      const mutation = `
        mutation {
          insert_room_one(object: {name: "${name}", intro: "${intro}", invite_code: "${inviteCode}"}) {
            uuid
          }
        }
      `;
      await client.mutate({ mutation });
      alert('房间创建成功！');
    }

    // 加入房间
    async function joinRoom() {
      const inviteCode = document.getElementById('join-code').value;
      const query = `
        query {
          room(where: {invite_code: {_eq: "${inviteCode}"}}) {
            uuid
          }
        }
      `;
      const result = await client.query({ query });
      if (result.data.room.length > 0) {
        currentRoom = result.data.room[0];
        alert('加入房间成功！');
      } else {
        alert('邀请码无效');
      }
    }

    // 发送消息
    async function sendMessage() {
      if (!currentUser || !currentRoom) {
        alert('请先登录并加入房间');
        return;
      }
      const content = document.getElementById('message-content').value;
      const mutation = `
        mutation {
          insert_message_one(object: {
            user_uuid: "${currentUser.uuid}",
            room_uuid: "${currentRoom.uuid}",
            content: "${content}"
          }) {
            uuid
          }
        }
      `;
      await client.mutate({ mutation });
      document.getElementById('message-content').value = '';
    }

    // 创建会议
    async function createMeeting() {
      const name = document.getElementById('meeting-name').value;
      const start = document.getElementById('start-time').value;
      const end = document.getElementById('end-time').value;
      const mutation = `
        mutation {
          insert_meeting(objects: [{
            name: "${name}",
            start_time: "${start}",
            end_time: "${end}"
          }]) {
            returning {
              uuid
            }
          }
        }
      `;
      await client.mutate({ mutation });
      alert('会议创建成功！');
    }

    // 添加笔记
    async function addNote() {
      const content = document.getElementById('note-content').value;
      const mutation = `
        mutation {
          insert_meeting_note(objects: [{
            content: "${content}",
            user_uuid: "${currentUser.uuid}",
            meeting_uuid: "some-meeting-uuid"  // 需要替换为实际会议UUID
          }]) {
            returning {
              uuid
            }
          }
        }
      `;
      await client.mutate({ mutation });
      alert('笔记添加成功！');
    }
  </script>
</body>
</html>
